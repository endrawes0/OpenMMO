name: CI - Full Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  rust-server:
    name: Rust Server
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: openmmo_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Run clippy
      run: cargo clippy --workspace --all-targets --all-features -- -D warnings

    - name: Build workspace
      run: cargo build --workspace --verbose

    - name: Run tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/openmmo_test
      run: cargo test --workspace --verbose

    - name: Security audit
      uses: actions-rs/audit-check@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

  godot-client:
    name: Godot Client
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3

    - name: Validate project
      run: |
        cd client
        godot --headless --check-only project.godot
        [ -f "scenes/Main.tscn" ] || { echo "Main.tscn not found"; exit 1; }
        [ -f "scenes/GameWorld.tscn" ] || { echo "GameWorld.tscn not found"; exit 1; }
        echo "Godot client validation passed"

  database-migrations:
    name: Database Migrations
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: openmmo_migration_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install sqlx-cli
      run: cargo install sqlx-cli --no-default-features --features native-tls,postgres

    - name: Test migrations
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/openmmo_migration_test
      run: |
        sqlx database create
        sqlx migrate run --source migrations
        echo "Database migrations validated"

  code-quality:
    name: Code Quality Gates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for secrets
      run: |
        PATTERNS=("password.*=" "secret.*=" "token.*=" "api_key.*=" "AKIA[0-9A-Z]{16}")
        for pattern in "${PATTERNS[@]}"; do
          if git grep -E "$pattern" -- . ':(exclude)*.md' ':(exclude)*.example' ':(exclude)rustfmt.toml' ':(exclude)clippy.toml' ':(exclude).github/workflows/' ':(exclude)client/scenes/' ':(exclude)client/scripts/' ':(exclude)scripts/' ':(exclude)*.proto' 2>/dev/null; then
            echo "Potential secret found"
            exit 1
          fi
        done

    - name: Validate file organization
      run: |
        echo "Checking project structure..."
        [ -d "server/" ] || { echo "server directory missing"; exit 1; }
        [ -d "client/" ] || { echo "client directory missing"; exit 1; }
        [ -d "migrations/" ] || { echo "migrations directory missing"; exit 1; }
        [ -f "AGENTS.md" ] || { echo "AGENTS.md missing"; exit 1; }
        echo "Project structure validation passed"

    - name: Check documentation
      run: |
        if git diff --name-only origin/master...HEAD | grep -E "\.(rs|gd)$"; then
          echo "Code changes detected, checking for documentation updates..."
          if ! git diff --name-only origin/master...HEAD | grep -E "\.(md|txt)$"; then
            echo "Warning: Code changes but no documentation updates"
          fi
        fi

  definition-of-done:
    name: Definition of Done Check
    runs-on: ubuntu-latest
    needs: [rust-server, godot-client, database-migrations, code-quality]
    if: always()
    
    steps:
    - name: Check all jobs passed
      run: |
        if [ "${{ needs.rust-server.result }}" != "success" ]; then
          echo "❌ Rust server checks failed"
          exit 1
        fi
        if [ "${{ needs.godot-client.result }}" != "success" ]; then
          echo "❌ Godot client checks failed"
          exit 1
        fi
        if [ "${{ needs.database-migrations.result }}" != "success" ]; then
          echo "❌ Database migration checks failed"
          exit 1
        fi
        if [ "${{ needs.code-quality.result }}" != "success" ]; then
          echo "❌ Code quality checks failed"
          exit 1
        fi
        echo "✅ All Definition of Done criteria met"