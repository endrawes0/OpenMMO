name: PR Validation

on:
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  validate-pr:
    name: Validate PR Requirements
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR description
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const body = pr.body || '';
          
          // Check for required sections
          const requiredSections = ['## Summary', '## Related Spec', '## Validation Steps'];
          const missingSections = requiredSections.filter(section => !body.includes(section));
          
          if (missingSections.length > 0) {
            core.setFailed(`PR description missing required sections: ${missingSections.join(', ')}`);
            return;
          }
          
          console.log('PR description validation passed');

    - name: Check for feature branch naming
      run: |
        BRANCH_NAME="${{ github.head_ref }}"
        if [[ "$BRANCH_NAME" != "feature/"* ]] && [[ "$BRANCH_NAME" != "bugfix/"* ]] && [[ "$BRANCH_NAME" != "master" ]]; then
          echo "Branch name should follow pattern: feature/<short-description> or bugfix/<short-description>"
          echo "Current branch: $BRANCH_NAME"
          exit 1
        fi
        echo "Branch naming validation passed"



    - name: Validate commit messages
      run: |
        echo "Validating commit messages..."
        
        # Get commits since master
        COMMITS=$(git rev-list origin/master..HEAD)
        
        for commit in $COMMITS; do
          MESSAGE=$(git log --format=%B -n 1 $commit)
          
          # Check for conventional commit format (optional but recommended)
          if [[ ${#MESSAGE} -lt 10 ]]; then
            echo "Commit message too short: $MESSAGE"
            exit 1
          fi
          
          # Check for signed commits (optional)
          if ! git verify-commit $commit >/dev/null 2>&1; then
            echo "Warning: Commit $commit is not signed"
          fi
        done
        
        echo "Commit message validation passed"

    - name: Check for documentation updates
      run: |
        echo "Checking for documentation updates..."
        
        CHANGED_FILES=$(git diff --name-only origin/master...HEAD)
        
        # If code files changed, check if docs were updated
        CODE_CHANGED=false
        DOCS_UPDATED=false
        
        for file in $CHANGED_FILES; do
          if [[ "$file" == *.rs ]] || [[ "$file" == *.gd ]] || [[ "$file" == *.proto ]]; then
            CODE_CHANGED=true
          fi
          
          if [[ "$file" == docs/* ]] || [[ "$file" == *.md ]]; then
            DOCS_UPDATED=true
          fi
        done
        
        if [ "$CODE_CHANGED" = true ] && [ "$DOCS_UPDATED" = false ]; then
          echo "Warning: Code changes detected but no documentation updates"
          echo "Consider updating relevant documentation"
        fi
        
        echo "Documentation check completed"

    - name: Check for secrets in code
      run: |
        echo "Checking for potential secrets..."
        
        # Common secret patterns
        PATTERNS=(
          "password\s*=\s*['\"][^'\"]+['\"]"
          "secret\s*=\s*['\"][^'\"]+['\"]"
          "token\s*=\s*['\"][^'\"]+['\"]"
          "api_key\s*=\s*['\"][^'\"]+['\"]"
          "AKIA[0-9A-Z]{16}"  # AWS access key
        )
        
        for pattern in "${PATTERNS[@]}"; do
          if git grep -E "$pattern" -- . ':(exclude)*.md' ':(exclude)*.txt' ':(exclude).sqlx/' 2>/dev/null; then
            echo "Potential secret found matching pattern: $pattern"
            exit 1
          fi
        done
        
        echo "Secret check passed"

    - name: Validate file sizes
      run: |
        echo "Checking file sizes..."
        
        # Check for unusually large files that might indicate binary assets
        git diff --name-only --diff-filter=d origin/master...HEAD | while read file; do
          if [ -f "$file" ]; then
            SIZE=$(stat -c%s "$file")
            if [ "$SIZE" -gt 10485760 ]; then  # 10MB
              echo "Warning: Large file detected: $file ($SIZE bytes)"
              echo "Consider using Git LFS for large assets"
            fi
          fi
        done
        
        echo "File size check completed"