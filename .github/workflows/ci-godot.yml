name: CI - Godot Client

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  godot-client:
    name: Godot Client CI
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: '4.5.1-stable'
        include-templates: true

    - name: Validate project and scripts
      run: |
        cd client
        godot --headless --check-only --path . --quit

    - name: Parse core scenes
      run: |
        cd client
        godot --headless --check-only --path . --quit scenes/Main.tscn
        godot --headless --check-only --path . --quit scenes/GameWorld.tscn

    - name: Smoke test core client modules
      run: |
        cd client
        godot --headless --path . --script res://test_modules.gd

    - name: Check scene structure
      run: |
        cd client
        echo "Checking required scenes exist..."
        [ -f "scenes/Main.tscn" ] || { echo "Main.tscn not found"; exit 1; }
        [ -f "scenes/GameWorld.tscn" ] || { echo "GameWorld.tscn not found"; exit 1; }
        echo "All required scenes found"

    - name: Check export presets
      run: |
        cd client
        if [ -f "export_presets.cfg" ]; then
          echo "Export presets file found - parsing"
          python - <<'PY'
import configparser, sys
cfg = configparser.ConfigParser()
with open("export_presets.cfg", "r", encoding="utf-8") as f:
    cfg.read_file(f)
presets = [section for section in cfg.sections() if section.startswith("preset.")]
if not presets:
    sys.exit("export_presets.cfg found but no [preset.*] sections detected")
print(f"Export presets parsed ({len(presets)} presets found)")
PY
        else
          echo "No export presets file found (optional for MVP)"
        fi

    - name: Validate project structure
      run: |
        cd client
        echo "Checking project structure..."
        [ -d "assets/" ] || { echo "assets directory not found"; exit 1; }
        [ -d "scenes/" ] || { echo "scenes directory not found"; exit 1; }
        [ -d "scripts/" ] || { echo "scripts directory not found"; exit 1; }
        [ -f "project.godot" ] || { echo "project.godot not found"; exit 1; }
        echo "Project structure validation passed"

    - name: Check for proper file organization
      run: |
        cd client
        echo "Checking file organization..."
        # Ensure no business logic in Godot scripts (basic check)
        if grep -r "database\|sql\|http" scripts/ 2>/dev/null; then
          echo "Warning: Potential business logic found in GDScript files"
          echo "According to AGENTS.md, business logic should be outside Godot scripts"
        fi
        echo "File organization check complete"
