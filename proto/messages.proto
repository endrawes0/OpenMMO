// OpenMMO Protocol Definition
// Core message types for client-server communication

syntax = "proto3";

package openmmo;

// Message envelope for all communications
message Envelope {
  uint32 sequence_id = 1;
  uint64 timestamp = 2;
  oneof payload {
    HandshakeRequest handshake_request = 3;
    HandshakeResponse handshake_response = 4;
    AuthRequest auth_request = 5;
    AuthResponse auth_response = 6;
    Ping ping = 7;
    Pong pong = 8;
    Error error = 9;
    Disconnect disconnect = 10;
    WorldSnapshot world_snapshot = 11;
    MovementIntent movement_intent = 12;
    CombatAction combat_action = 13;
    EntityUpdate entity_update = 14;
    CharacterListRequest character_list_request = 15;
    CharacterListResponse character_list_response = 16;
    CharacterCreateRequest character_create_request = 17;
    CharacterCreateResponse character_create_response = 18;
    CharacterSelectRequest character_select_request = 19;
    CharacterSelectResponse character_select_response = 20;
    CharacterDeleteRequest character_delete_request = 21;
    CharacterDeleteResponse character_delete_response = 22;
  }
}

// Handshake messages
message HandshakeRequest {
  string client_version = 1;
  string protocol_version = 2;
  uint32 supported_features = 3; // Bitfield of supported features
}

message HandshakeResponse {
  bool accepted = 1;
  string server_version = 2;
  string protocol_version = 3;
  uint32 server_features = 4; // Bitfield of server features
  string message = 5; // Optional message (error or info)
}

// Authentication messages
message AuthRequest {
  string username = 1;
  string password_hash = 2; // Client-side hashed password
  string character_name = 3; // Optional: specific character to login as
}

message AuthResponse {
  bool success = 1;
  string session_token = 2; // Only present on success
  string message = 3; // Error message or success info
  uint64 player_id = 4; // Player entity ID
  uint64 character_id = 5; // Character entity ID
}

// Ping/Pong for connection health
message Ping {
  uint64 timestamp = 1;
}

message Pong {
  uint64 timestamp = 1; // Echo back the ping timestamp
}

// Error messages
message Error {
  enum ErrorCode {
    UNKNOWN_ERROR = 0;
    INVALID_REQUEST = 1;
    AUTHENTICATION_FAILED = 2;
    SESSION_EXPIRED = 3;
    CHARACTER_NOT_FOUND = 4;
    SERVER_FULL = 5;
    PROTOCOL_MISMATCH = 6;
    RATE_LIMITED = 7;
  }
  ErrorCode code = 1;
  string message = 2;
  map<string, string> details = 3; // Additional error context
}

// Disconnect notification
message Disconnect {
  enum DisconnectReason {
    UNKNOWN = 0;
    CLIENT_REQUEST = 1;
    SERVER_SHUTDOWN = 2;
    TIMEOUT = 3;
    KICKED = 4;
    BANNED = 5;
  }
  DisconnectReason reason = 1;
  string message = 2;
}

// Basic world snapshot for initial state sync
message WorldSnapshot {
  uint64 snapshot_id = 1;
  repeated Entity entities = 2;
  uint64 player_entity_id = 3; // Which entity is the player
  string zone_name = 4;
}

// Basic entity representation
message Entity {
  uint64 id = 1;
  string entity_type = 2; // "player", "mob", "npc", etc.
  Vector3 position = 3;
  Vector3 rotation = 4;
  EntityState state = 5;
}

// 3D vector for positions/rotations
message Vector3 {
  float x = 1;
  float y = 2;
  float z = 3;
}

// Entity state information
message EntityState {
  enum MovementState {
    IDLE = 0;
    WALKING = 1;
    RUNNING = 2;
    DEAD = 3;
  }
  MovementState movement_state = 1;
  float health_percent = 2; // 0.0 to 1.0
  string display_name = 3;
}

// Movement intent from client
message MovementIntent {
  Vector3 target_position = 1;
  float speed_modifier = 2; // 1.0 = normal speed
  bool stop_movement = 3; // If true, stop all movement
}

// Combat action from client
message CombatAction {
  enum ActionType {
    AUTO_ATTACK = 0;
    ABILITY = 1;
  }
  ActionType action_type = 1;
  uint64 target_entity_id = 2;
  uint32 ability_id = 3; // Only used for ABILITY type
}

// Entity update from server (for real-time sync)
message EntityUpdate {
  uint64 entity_id = 1;
  Vector3 position = 2;
  Vector3 rotation = 3;
  EntityState state = 4;
  repeated EntityEffect effects = 5; // Status effects, damage numbers, etc.
}

// Visual effects for entity updates
message EntityEffect {
  enum EffectType {
    DAMAGE_NUMBER = 0;
    STATUS_EFFECT = 1;
    DEATH = 2;
    RESPAWN = 3;
  }
  EffectType effect_type = 1;
  string effect_data = 2; // JSON-encoded effect data
}

// Character management messages

// Request character list for account
message CharacterListRequest {
}

// Response with character list
message CharacterListResponse {
  repeated CharacterInfo characters = 1;
}

// Character information
message CharacterInfo {
  uint64 id = 1;
  string name = 2;
  string class = 3;
  uint32 level = 4;
  uint64 experience = 5;
  string zone_id = 6;
  uint32 health = 7;
  uint32 max_health = 8;
  string resource_type = 9;
  uint32 resource_value = 10;
  uint32 max_resource = 11;
  bool is_online = 12;
}

// Create character request
message CharacterCreateRequest {
  string name = 1;
  string class = 2;
}

// Create character response
message CharacterCreateResponse {
  bool success = 1;
  CharacterInfo character = 2;
  string error_message = 3;
}

// Select character request
message CharacterSelectRequest {
  uint64 character_id = 1;
}

// Select character response
message CharacterSelectResponse {
  bool success = 1;
  CharacterInfo character = 2;
  string error_message = 3;
}

// Delete character request
message CharacterDeleteRequest {
  uint64 character_id = 1;
}

// Delete character response
message CharacterDeleteResponse {
  bool success = 1;
  string error_message = 2;
}